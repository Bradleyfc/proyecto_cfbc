{% extends 'base.html' %} {% block content %}
{% load static %}
{% load curso_tags %}
<div class="container">
  <h2 class="text-center">Bienvenido {{ user.first_name|default:user.username }}</h2>
</div>
<br />
<div class="container" my-4>



  {% if group_name == 'Secretaria' %}
  <h3 class="text-center">Administrar los Cursos Disponibles en el centro</h3>
  {% else %}
  <h3 class="text-center">Listado de Cursos Disponibles</h3>
  {% endif %}

  <br>
  <div class="row align-items-center mb-3">
    <!-- Filtros a la izquierda -->
    <div class="col-md-4">
      <div class="row">
        <div class="col-6">
          <select class="form-select" id="filtroArea" onchange="filtrarCursos()">
            <option value="">Todas las Áreas</option>
            <option value="idiomas">Idiomas</option>
            <option value="humanidades">Humanidades</option>
            <option value="computacion">Computación</option>
            <option value="diseno">Diseño</option>
            <option value="adolescentes">Adolescentes</option>
            <option value="teologia">Teología</option>
          </select>
        </div>
        <div class="col-6">
          <select class="form-select" id="filtroTipo" onchange="filtrarCursos()">
            <option value="">Todos los Tipos</option>
            <option value="curso">Curso</option>
            <option value="diplomado">Diplomado</option>
            <option value="grado">Grado</option>
            <option value="taller">Taller</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Botón de agregar curso (solo para Secretaria) en el centro -->
    <div class="col-md-4 text-center">
      {% if group_name == 'Secretaria' %}
      <a class="btn btn-primary" href="{% url 'principal:crear_cursos'%}">
        <i class="bi bi-plus-circle"></i> Agregar Curso
      </a>
      {% endif %}
    </div>

    <!-- Opciones de vista a la derecha -->
    <div class="col-md-4 text-end">
      <div class="btn-group" role="group" aria-label="Vista de cursos">
        <button type="button" class="btn btn-outline-secondary active" id="vistaCards" onclick="cambiarVista('cards')">
          <i class="bi bi-grid-3x3-gap"></i> Tarjetas
        </button>
        <button type="button" class="btn btn-outline-secondary" id="vistaLista" onclick="cambiarVista('lista')">
          <i class="bi bi-list"></i> Lista
        </button>
      </div>
    </div>
  </div>



  <!-- Mensaje de creacion -->
  <!-- 
  {% if messages %}
  <div class="container" mt-3>
    {% for message in messages %}
    <div class="alert alert-success" role="alert">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %} -->

  <style>
    .card-img-top {
      width: 100%;
      height: 200px;
      object-fit: cover;
      transition: all 0.4s ease;
      cursor: pointer;
    }

    /* Efectos hover para las imágenes */
    .card:hover .card-img-top {
      transform: scale(1.05);
      filter: brightness(1.1) contrast(1.1);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    /* Efecto hover para toda la tarjeta */
    .card {
      transition: all 0.3s ease;
      border: 1px solid #dee2e6;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      border-color: #007bff;
    }

    /* Contenedor de imagen simplificado */
    .card-img-container {
      overflow: hidden;
    }

    /* Estilos para vista de lista */
    .vista-lista .card {
      flex-direction: row;
      margin-bottom: 1rem;
      max-width: 50%;
      margin-left: auto;
      margin-right: auto;
    }

    .vista-lista .card-img-top {
      width: 150px;
      height: 120px;
      object-fit: cover;
      border-radius: 0.375rem 0 0 0.375rem;
      flex-shrink: 0;
    }

    .vista-lista .card-body {
      flex: 1;
      padding: 0.75rem;
    }

    .vista-lista .col {
      flex: 0 0 100%;
      max-width: 100%;
      display: flex;
      justify-content: center;
    }

    /* Ajustes para vista de lista en hover */
    .vista-lista .card:hover .card-img-top {
      transform: scale(1.02);
    }

    .vista-lista .card:hover {
      transform: translateX(5px);
    }

    /* Transición suave */
    .cursos-container {
      transition: all 0.3s ease;
    }

    /* Efecto de brillo en los badges */
    .card:hover .badge {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }
  </style>

  <div id="cursosContainer" class="row row-cols-1 row-cols-md-3 g-4 my-4 cursos-container">
    {% for course in courses %}
    <div class="col" data-area="{{ course.area }}" data-tipo="{{ course.tipo }}">
      <div class="card">
        <div class="card-img-container">
          <img src="{{ course.image.url }}" class="card-img-top" alt="{{course.name}}">
        </div>
        <div class="card-body">
          <h5 class="card-title">{{course.name}}</h5>
          <div class="mb-2">
            <span class="badge bg-primary me-1">{{ course.get_area_display }}</span>
            <span class="badge bg-secondary">{{ course.get_tipo_display }}</span>
          </div>
          <p class="card-text">{{course.description}}</p>
          <!-- <p class="card-text">
            <strong>Profesor:</strong> {{course.teacher.first_name}} {{course.teacher.last_name}}
          </p> -->
          <p class="card-text">
            <strong>Cantidad de Clases:</strong> {{course.class_quantity}}
          </p>
          <p class="card-text"><strong>Cantidad de Inscritos:</strong> {{course.enrollment_count}}</p>

          <!-- Agregando fecha límite de inscripción -->
          {% if course.enrollment_deadline %}
          <p class="card-text">
            <strong>Fecha límite de inscripción:</strong> {{course.enrollment_deadline|date:"d/m/Y"}}
          </p>
          {% endif %}

          <!-- Agregando fecha de inicio del curso -->
          {% if course.start_date and course.status != 'P' and course.status != 'F' %}
          <p class="card-text">
            <strong>Fecha de inicio del Curso:</strong> {{course.start_date|date:"d/m/Y"}}
          </p>
          {% endif %}




          <!-- Agregando la informacion del curso con estado dinámico -->
          {% if course.get_dynamic_status == 'F' %}
          <h5><span class="badge bg-danger w-100">{{course.get_dynamic_status_display|upper}}</span></h5>
          {% elif course.get_dynamic_status == 'P' %}
          <h5><span class="badge bg-warning text-dark w-100">{{course.get_dynamic_status_display|upper}}</span></h5>
          {% elif course.get_dynamic_status == 'I' %}
          <h5><span class="badge bg-success w-100">{{course.get_dynamic_status_display|upper}}</span></h5>
          {% elif course.get_dynamic_status == 'IT' %}
          <h5><span class="badge bg-info w-100">{{course.get_dynamic_status_display|upper}}</span></h5>
          {% endif %}


          <!-- Boton de aplicar al curso o etiquetas de estado -->
          {% if group_name == 'Estudiantes' %}
          <!-- Verificar el estado de la solicitud para este curso usando los template tags -->
          {% tiene_solicitud_pendiente user.id course.id as tiene_solicitud_pendiente %}
          {% tiene_solicitud_rechazada user.id course.id as tiene_solicitud_rechazada %}
          {% if tiene_solicitud_pendiente %}
          <h5><span class="badge bg-warning text-dark w-100">Pendiente a Aprobación</span></h5>
          {% elif tiene_solicitud_rechazada %}
          <h5><span class="badge bg-danger w-100">Aplicación Denegada</span></h5>
          {% elif course.is_enrolled %}
          <p class="fw-bold bg-light text-center">Ya estás inscrito</p>
          {% elif course.get_dynamic_status == 'I' and course.formulario_aplicacion %}
          <div class="text-center">
            <a class="btn btn-sm btn-success" href="{% url 'principal:aplicar_curso' course.id %}">
              <i class="bi bi-file-earmark-text"></i> Aplicar al Curso
            </a>
          </div>
          {% elif course.get_dynamic_status == 'I' %}
          <!-- No mostrar nada si no hay formulario -->
          <!-- <p class="text-muted small">
                Estado: {{ course.status }} | 
                Tiene formulario: {{ course.tiene_formulario|yesno:"Sí,No" }}
                {% if course.formulario_aplicacion %}
                  | ID Formulario: {{ course.formulario_aplicacion.id }}
                {% endif %}
              </p> -->
          {% endif %}
          {% endif %}



          {% if group_name == 'Secretaria' %}
          <div class="row align-items-center mb-2">
            <!-- Botón Editar - Izquierda -->
            <div class="col-6">
              <a class="btn btn-sm btn-warning w-100" href="{% url 'principal:editar_curso' course.id %}">
                <i class="bi bi-pencil-square"></i> Editar
              </a>
            </div>

            <!-- Botón Eliminar - Derecha -->
            <div class="col-6">
              <a class="btn btn-sm btn-danger w-100" href="{% url 'principal:eliminar_curso' course.id %}"
                onclick="return confirm('¿Estás seguro de que deseas eliminar este curso?')">
                <i class="bi bi-trash"></i> Eliminar
              </a>
            </div>
          </div>

          <!-- Botón Formulario - Debajo y centrado -->
          <div class="text-center">
            {% if course.formulario_aplicacion %}
            <a class="btn btn-xs btn-info" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;"
              href="{% url 'principal:formulario_update' course.formulario_aplicacion.id %}">
              <i class="bi bi-pencil-square"></i> Editar Formulario de Aplicación
            </a>
            {% else %}
            <a class="btn btn-xs btn-success" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;"
              href="{% url 'principal:formulario_create' %}?curso_id={{ course.id }}">
              <i class="bi bi-plus-circle"></i> Crear Formulario de Aplicación
            </a>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  function filtrarCursos() {
    const filtroArea = document.getElementById('filtroArea').value;
    const filtroTipo = document.getElementById('filtroTipo').value;
    const cards = document.querySelectorAll('#cursosContainer .col');

    cards.forEach(card => {
      const areaCard = card.getAttribute('data-area');
      const tipoCard = card.getAttribute('data-tipo');

      let mostrar = true;

      // Filtrar por área
      if (filtroArea && filtroArea !== areaCard) {
        mostrar = false;
      }

      // Filtrar por tipo
      if (filtroTipo && filtroTipo !== tipoCard) {
        mostrar = false;
      }

      card.style.display = mostrar ? 'block' : 'none';
    });
  }

  function cambiarVista(vista) {
    const container = document.getElementById('cursosContainer');
    const vistaCardsBtn = document.getElementById('vistaCards');
    const vistaListaBtn = document.getElementById('vistaLista');

    if (vista === 'cards') {
      // Vista de tarjetas (3 columnas)
      container.className = 'row row-cols-1 row-cols-md-3 g-4 my-4 cursos-container';
      container.classList.remove('vista-lista');

      // Actualizar botones
      vistaCardsBtn.classList.add('active');
      vistaListaBtn.classList.remove('active');

    } else if (vista === 'lista') {
      // Vista de lista (1 columna)
      container.className = 'row row-cols-1 g-4 my-4 cursos-container vista-lista';

      // Actualizar botones
      vistaListaBtn.classList.add('active');
      vistaCardsBtn.classList.remove('active');
    }
  }
</script>

{% endblock %}